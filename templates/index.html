<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Zamówień</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <style>
        .progress {
            height: 25px;
            background-color: #e9ecef;
            position: relative;
        }

        .progress-bar {
            transition: width 1s ease;
        }

        .progress-bar-warning {
            background-color: yellow !important;
        }

        .progress-bar-info {
            background-color: #17a2b8 !important;
        }

        .progress-bar-danger {
            background-color: red !important;
        }

        .data-label {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            color: black;
            font-weight: bold;
        }

        .overdue-text {
            color: red !important;
            font-weight: bold;
        }

        .overdue-text a {
            color: red !important;
            text-decoration: none;
        }

        .completed-text {
            color: green !important;
            font-weight: bold;
        }

        .completed-text a {
            color: green !important;
            text-decoration: none;
        }

        .narrow-column {
            width: 15%;
        }

        .wide-column {
            width: 30%;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        .order-column {
            width: 16%;
        }

        .person-column {
            width: 15%;
        }

        value-column {
            width: 12%;
        }

        .comment-column {
            width: 10%;
        }

        .dl-column {
            width: 10%;
        }

        .highlight-deadline {
            background-color: red !important;
            color: white;
        }
    </style>
</head>
<body>
<div class="container my-5">
    <h2 class="text-center">Tabela Zamówień</h2>
    <form method="get" class="mb-4">
        <div class="row">
            <div class="col-md-4">
                <label for="start_date">Data początkowa:</label>
                <input type="date" id="start_date" name="start_date" class="form-control">
            </div>
            <div class="col-md-4">
                <label for="end_date">Data końcowa:</label>
                <input type="date" id="end_date" name="end_date" class="form-control">
            </div>
            <div class="col-md-4">
                <label for="osoba">Osoba:</label>
                <select id="osoba" name="osoba" class="form-control">
                    <option value="">Wszystkie</option>
                    {% for osoba in unique_people %}
                        <option value="{{ osoba }}">{{ osoba }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary me-2">Filtruj</button>
                <a href="/" class="btn btn-secondary">Wyczyść filtr</a>
            </div>
        </div>
    </form>
    <div class="table-responsive">
        <table id="order-table" class="table table-striped table-bordered" style="width:100%">
            <thead>
            <tr>
                <th class="order-column">Numer Zamówienia</th>
                <th class="person-column">Osoba</th>
                <th class="value-column">Wartość Zamówienia</th>
                <th class="wide-column">Termometr</th>
                <th class="comment-column">Komentarze</th>
                <th class="dl-column">Deadline</th>
                <th class="narrow-column">Status</th>
                <th class="narrow-column">Dodaj Komentarz</th>
            </tr>
            </thead>
            <tbody>
            {% for zamowienie in zamowienia %}
                <tr>
                    <td>{{ zamowienie.numer }}</td>
                    <td>{% if zamowienie.osoba %}
                        {{ zamowienie.osoba }}
                    {% else %}
                        Brak
                    {% endif %}</td>
                    <td>{{ zamowienie.wartosc }}</td>
                    <td data-order="{{ zamowienie.timeline_progress }}">
                        <div class="progress">
                            <div class="progress-bar
        {% if zamowienie.is_overdue %} progress-bar-danger
        {% elif zamowienie.time_diff <= 7 and zamowienie.time_diff >= 0 %} progress-bar-warning
        {% else %} progress-bar-info {% endif %}"
                                 role="progressbar"
                                 style="width: {{ zamowienie.timeline_progress_scaled }}%;"></div>
                            <span class="data-label">{{ zamowienie.data_potwierdzona }}</span>
                        </div>
                    </td>
                    <td>{{ zamowienie.comments_count }}</td>
                    <td class="{% if zamowienie.next_deadline != 'Brak' %} highlight-deadline {% endif %}">{{ zamowienie.next_deadline }}</td>
                    <td>
                        <form method="post" action="{% url 'update_status' zamowienie_id=zamowienie.id %}">
                            {% csrf_token %}
                            <select name="status" class="form-select" onchange="confirmStatusChange(this)">
                                <option value="Brak" hidden {% if not zamowienie.status %}selected{% endif %}>Brak
                                </option>
                                <option value="Oczekiwanie"
                                        {% if zamowienie.status == 'Oczekiwanie' %}selected{% endif %}>Oczekiwanie
                                </option>
                                <option value="W trakcie" {% if zamowienie.status == 'W trakcie' %}selected{% endif %}>W
                                    trakcie
                                </option>
                                <option value="Zrealizowane"
                                        {% if zamowienie.status == 'Zrealizowane' %}selected{% endif %}>Zrealizowane
                                </option>
                            </select>
                        </form>
                    </td>
                    <td>
                        <a href="{% url 'comments' zamowienie_id=zamowienie.id %}" class="btn btn-primary btn-sm">Dodaj
                            Komentarz</a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
        $(document).ready(function () {
            $('#order-table').DataTable({
                "paging": true,
                "pageLength": 100,
                "searching": true,
                "order": [[0, "asc"]],
                "autoWidth": false,
                "columnDefs": [
                    {"targets": [6], "width": "15%"}
                ]
            });
        });

        function confirmStatusChange(selectElement) {
            if (confirm("Czy na pewno chcesz zastosować zmiany?")) {
                selectElement.form.submit();
            } else {
                selectElement.value = selectElement.querySelector("option[selected]").value;
            }
        }
    </script>
</div>
</body>
</html>